<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Sessions - The Kronos Grimoire</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A deep dive into the game&#x27;s internals and the Kronos project orchestration">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../foreword.html">Foreword</a></li><li class="chapter-item expanded "><a href="../../internals/args.html"><strong aria-hidden="true">1.</strong> Graphical Client Arguments</a></li><li class="chapter-item expanded "><a href="../../internals/string-id.html"><strong aria-hidden="true">2.</strong> String IDs</a></li><li class="chapter-item expanded "><a href="../../internals/dml/index.html"><strong aria-hidden="true">3.</strong> Data Management Layer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../internals/dml/protocols.html"><strong aria-hidden="true">3.1.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../../internals/dml/messages.html"><strong aria-hidden="true">3.2.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../../internals/dml/tables.html"><strong aria-hidden="true">3.3.</strong> Tables</a></li></ol></li><li class="chapter-item expanded "><a href="../../internals/object-property/index.html"><strong aria-hidden="true">4.</strong> ObjectProperty</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../internals/object-property/property-classes.html"><strong aria-hidden="true">4.1.</strong> Property Classes</a></li><li class="chapter-item expanded "><a href="../../internals/object-property/serialization.html"><strong aria-hidden="true">4.2.</strong> Serialization</a></li></ol></li><li class="chapter-item expanded "><a href="../../internals/protocol/index.html"><strong aria-hidden="true">5.</strong> Network Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../internals/protocol/framing.html"><strong aria-hidden="true">5.1.</strong> Framing</a></li><li class="chapter-item expanded "><a href="../../internals/protocol/control.html"><strong aria-hidden="true">5.2.</strong> Control Messages</a></li><li class="chapter-item expanded "><a href="../../internals/protocol/data.html"><strong aria-hidden="true">5.3.</strong> Data Messages</a></li><li class="chapter-item expanded "><a href="../../internals/protocol/sessions.html" class="active"><strong aria-hidden="true">5.4.</strong> Sessions</a></li></ol></li><li class="chapter-item expanded "><a href="../../internals/kiwad.html"><strong aria-hidden="true">6.</strong> KIWAD Archives</a></li><li class="chapter-item expanded "><a href="../../internals/login-server/index.html"><strong aria-hidden="true">7.</strong> Login Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../internals/login-server/groundwork.html"><strong aria-hidden="true">7.1.</strong> Groundwork</a></li><li class="chapter-item expanded "><a href="../../internals/login-server/auth.html"><strong aria-hidden="true">7.2.</strong> Authentication</a></li><li class="chapter-item expanded "><a href="../../internals/login-server/transition.html"><strong aria-hidden="true">7.3.</strong> Game Transition</a></li><li class="chapter-item expanded "><a href="../../internals/login-server/chars.html"><strong aria-hidden="true">7.4.</strong> Character Management</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kronos Grimoire</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sessions"><a class="header" href="#sessions">Sessions</a></h1>
<p>Sessions between a client and a server are an important aspect of the network communication
as they grant various privileges and confirm the authenticity of a connecting clients.</p>
<h2 id="handshake"><a class="header" href="#handshake">Handshake</a></h2>
<p>To establish a new sessions between two peers, either directly after a client opened a
connection or after the <a href="#refreshing-a-session">invalidation of a session</a>, a handshake
must be performed.</p>
<p>Clients should listen for <a href="./control.html#session-offer">Session Offer</a> messages at any time,
and respond with the appropriate <a href="./control.html#session-accept">Session Accept</a> after
receiving it.</p>
<p>When the session IDs match and the server does not respond with yet another
<a href="./control.html#session-offer">Session Offer</a> message, the session should be considered
established.</p>
<p>Both parties are expected to cache the relevant information from the handshake, such as
server uptime values, the timestamp the messages were sent, and obiously also the ID.
Various algorithms may rely on these data as unique variables individually assigned to
every client.</p>
<h2 id="refreshing-a-session"><a class="header" href="#refreshing-a-session">Refreshing a session</a></h2>
<p>During the lifetime of a TCP or UDP connection with the server, a very common event to
expect is such sessions actually being dropped in the middle of operations.</p>
<p>This act of dropping sessions is generally taking place when a client connects to
several servers at the same time and establishes sessions with them while already maintaining
a session with one of the servers. The server in question then tells all other servers
(including the ones the client is still connected to) to drop any sessions with that specific
client.</p>
<p>But instead of closing the underlying socket, the session will be refreshed. Since servers
are assuming that active exchange of messages only happens with one of them at the same
time, regardless of how many a client is actually connected to, a server will wait for the
first message from a client after the session invalidation, ignore it, and instead initiate
the <a href="#handshake">handshaking process</a> with a different ID.</p>
<p>When the process is completed, the client is expected to re-send its last message prior to
receiving a new <a href="./control.html#session-offer">Session Offer</a> message as the server ignored
it up to that point.</p>
<h2 id="session-id"><a class="header" href="#session-id">Session ID</a></h2>
<p>The session ID is a unique identifier assigned to every active session individually. It is
represented as an unsigned 16-bit integer and only one connection may occupy any valid
session ID at the same time.</p>
<p>A value of <code>0</code> is reserved to the server to indicate that a
<a href="./control.html#keep-alive">Keep Alive</a> message is server-initiated. It should never be
assigned to clients in order to avoid confusion of frame types.</p>
<h2 id="heartbeat"><a class="header" href="#heartbeat">Heartbeat</a></h2>
<p>When the <a href="#handshake">handshake</a> was successfully completed and the session is up and
running, the heartbeating process must begin in order to keep the session alive.</p>
<p>This step involves exchanging <a href="./control.html#keep-alive">Keep Alive</a> and corresponding
<a href="./control.html#keep-alive-rsp">Keep Alive Rsp</a> messages at fixed intervals and waiting
for the response of the peer.</p>
<p>Clients send such a request every <strong>10 seconds</strong>, whereas servers independently do so
every <strong>60 seconds</strong>.</p>
<p>When no response had been received directly before sending another request, the connection
is considered dead and the underlying socket should be closed.</p>
<h2 id="access-level"><a class="header" href="#access-level">Access Level</a></h2>
<p>Access Levels are numeric values denoting a specific set of permissions associated with
the session between an individual client and the server. Generally speaking, the higher
the value, the higher the permissions it grants.</p>
<p>Every DML message may have an access level value specified as a minimum threshold that
must be met in order for a peer to be allowed to process the data.</p>
<p>A non-exhaustive list of known values and their meanings is:</p>
<table><thead><tr><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>0</code></td><td>No special requirements; can be used anytime</td></tr>
<tr><td><code>1</code></td><td>A valid session must be established in order to process the message</td></tr>
</tbody></table>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../internals/protocol/data.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../internals/kiwad.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../internals/protocol/data.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../internals/kiwad.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
